const data = [
  {
    question:
      "Ranger les sept nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [1.1, 1.29, 1.56, 1.65, 1.7, 1.78, 1.89],
    lvl: 1,
  },
  {
    question:
      "Ranger les cinq nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [2.04, 2.09, 2.6, 2.8, 2.89],
    lvl: 1,
  },
  {
    question:
      "Ranger les cinq nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [2.04, 2.09, 2.6, 2.8, 2.89],
    lvl: 1,
  },
  {
    question:
      "Ranger les sept nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [0.04, 0.09, 0.1, 0.35, 0.6, 0.8, 0.89],
    lvl: 1,
  },
  {
    question:
      "Ranger les sept nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [0.04, 0.09, 0.1, 0.35, 0.6, 0.8, 0.89],
    lvl: 1,
  },
  {
    question:
      "Ranger les sept nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [0.04, 0.09, 0.1, 0.35, 0.6, 0.8, 0.89],
    lvl: 1,
  },
  {
    question:
      "Ranger les sept nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [0.04, 0.09, 0.1, 0.35, 0.6, 0.8, 0.89],
    lvl: 1,
  },
  {
    question:
      "Ranger les sept nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [0.04, 0.09, 0.1, 0.35, 0.6, 0.8, 0.89],
    lvl: 1,
  },
  {
    question:
      "Ranger les sept nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [0.04, 0.09, 0.1, 0.35, 0.6, 0.8, 0.89],
    lvl: 1,
  },
  {
    question:
      "Ranger les sept nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [0.04, 0.09, 0.1, 0.35, 0.6, 0.8, 0.89],
    lvl: 1,
  },
  {
    question:
      "Ranger les sept nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [0.04, 0.09, 0.1, 0.35, 0.6, 0.8, 0.89],
    lvl: 1,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [2.082, 2.422, 2.5, 2.56],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [1.082, 1.422, 1.5, 1.59],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [2.562, 2.82, 4.62, 3.9],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [4.08, 4.42, 4.5, 4.59],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [2.82, 2.42, 2.5, 2.56],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [1.82, 1.42, 1.5, 1.59],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [2.52, 2.82, 4.62, 3.9],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [4.02, 4.42, 4.56, 4.59],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [2.02, 2.42, 2.5, 2.56],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [1.08, 1.42, 1.5, 1.59],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [2.52, 2.82, 4.62, 3.9],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [4.08, 4.42, 4.5, 4.59],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [2.02, 2.42, 2.5, 2.56],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [1.08, 1.42, 1.5, 1.59],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [2.52, 2.82, 4.62, 3.9],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [4.08, 4.42, 4.5, 4.59],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [2.02, 2.42, 2.5, 2.56],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [1.08, 1.42, 1.5, 1.59],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [2.56, 2.82, 4.62, 3.9],
    lvl: 2,
  },
  {
    question:
      "Ranger les quatre nombres suivants par ordre croissant (du plus petit au plus grand)",
    correct: [4.02, 4.42, 4.5, 4.59],
    lvl: 2,
  },
];

const question = document.querySelector(".questions");
const answers = document.querySelector(".answers");
const title = document.querySelector("#title");
const timer = document.getElementById("timer");
const next = document.querySelector("#next");
const modal = document.querySelector(".modal");
const retourBtn = document.querySelector("#retour");

const total = localStorage.getItem("number");
const arrLvl = data
  .filter((item) => item.lvl == localStorage.getItem("niveaux"))
  .slice(0, total);
let active = 0;
let trys = 0;
let current = question.children;

/* Lit exercice LORS QUE L'USER CLICK SUR LE TITRE ATM */
title.addEventListener("click", speak);
const utterance = new SpeechSynthesisUtterance();

let isPlaying;

utterance.lang = "fr-FR";
utterance.rate = 0.7;

function speak() {
  if (!isPlaying) {
    isPlaying = !isPlaying;
    return speechSynthesis.speak(utterance);
  }
  isPlaying = false;
  speechSynthesis.cancel();
}

utterance.addEventListener("end", () => (isPlaying = false));

function setText(text) {
  utterance.text = text;
}

/* Modal */
function displayModal() {
  modal.style.display = "block";
  modal.innerHTML = `<h2>Vous avez encore ${essais()} ${
    essais() === 1 ? "essai" : "essais"
  }. Êtes vous sur de vouloir quitter cette page ?</h2>
    <div class="confirmer">
    <span class="confimer" onclick="confirmer()">Confimer</span>
    <span class="annuler" onclick="annuler()">Annuler</span>
    </div>
    `;
}

function annuler() {
  modal.style.display = "none";
}

function confirmer() {
  window.location = "exercice.html";
}

/* Exercice  */
const random = () => Math.floor(Math.random() * Math.floor(arrLvl.length));
const essais = () => 3 - trys;

next.addEventListener("click", verify);

/* Control nombre d'essais */
function tryNumber() {
  if (trys === 3) {
    removeClick();
    displayResult();
  }
}

function removeClick() {
  document.querySelectorAll(".indicator").forEach((el, i) => {
    el.style.pointerEvents = "none";
  });
}

/* Affiche le résult final */
function displayResult() {
  document.querySelectorAll(".indicator").forEach((el, i) => {
    el.addEventListener("click", (e) => {
      renderActive(i, e);
    });
  });

  trys += 1;
  tryNumber();

  timer.style.display = "none";
  title.innerText = "";

  document.querySelectorAll(".indicator").forEach((el) => {
    el.classList.add("result");
  });

  arrLvl.map((item, i) => {
    !item.test
      ? current[i].classList.add("striped")
      : current[i].classList.contains("striped")
      ? current[i].classList.add("completed2")
      : current[i].classList.add("completed");
  });

  return (answers.innerHTML = `
       <div class="results_Content">
       <h2>${
         trys !== 4
           ? `Cliquez sur un des indicators pour essayez de nouveau.
Vous avez encore ${essais()} ${essais() === 1 ? "essai" : "essais"}.`
           : " Vous n'avez plus essai ;("
       }</h2>
        <span class="total">${random() * 10}%</span>
        <span class="total_sur">${random()} sur ${arrLvl.length}</span>
        <button class="blueBtn return" onclick="returnToExerciceMenu()" id="exercice">Retour</button>
       
      </div>   
    `);

  /* true results*/
  // <div class="results_Content">
  //   <span class="total">
  //     ${(arrLvl.filter((el) => el.test === true).length / arrLvl.length) * 100}%
  //   </span>
  //   <span class="total_sur">
  //     ${arrLvl.filter((el) => el.test === true).length} sur ${arrLvl.length}
  //   </span>
  //   <button class="blueBtn return" id="exercice">
  //     Retour
  //   </button>
  // </div>;
}

function returnToExerciceMenu() {
  if (trys !== 4) {
    return displayModal();
  }

  window.location = "exercice.html";
}

/* Correction d'un exercice*/
function verify() {
  const result = document.querySelectorAll(".draggable");
  let test = [];
  result.forEach((el) => {
    test.push(parseFloat(el.innerHTML));
  });

  const correct =
    JSON.stringify(test) === JSON.stringify(arrLvl[active].correct);

  arrLvl[active].test = correct;

  if (trys !== 0 && !correct) return;

  completed((arrLvl[active].test = correct));

  active += 1;
  answers.innerHTML = "";

  if (active === arrLvl.length) {
    current[active - 1].classList.remove("active");
    current[active - 1].classList.remove("activeTry");
    next.style.opacity = "0";
    return displayResult();
  }

  renderAnwers(active);
  renderActive(active);
}

/* Change le style des indicators des questions */
function completed(test) {
  current[active].classList.remove("striped");
  let completed = trys === 0 ? "completed" : "completed2";

  return test
    ? current[active].classList.add(`${completed}`)
    : current[active].classList.add("striped");
}

/* Afiche le menu aprés un essais */
function renderBackBtn() {
  retourBtn.style.display = "block";
  retourBtn.addEventListener(
    "click",
    () => (window.location = "exercice.html")
  );
}

/* change le style de l'indicator sur la question active */
function renderActive(activ) {
  active = activ;

  renderAnwers(active);

  document.querySelectorAll(".indicator").forEach((el) => {
    el.classList.remove("active");
    el.classList.remove("result");
    el.classList.remove("activeTry");
  });

  const test = current[active].classList.contains("striped")
    ? current[active].classList.add("activeTry")
    : current[active].classList.add("active");

  return test;
}

/* Affiche la question */
function renderAnwers(active) {
  answers.innerHTML = "";
  next.style.opacity = "1";
  const shuffle = [...arrLvl[active].correct].sort(() => Math.random() - 0.5);

  title.innerText = arrLvl[active].question;
  setText(arrLvl[active].question);

  shuffle.map((item, i) => {
    const el = document.createElement("div");
    el.classList.add("dropabble");
    el.innerHTML = `<div class="outer">${i + 1}</div>
        <div class="drag"><div class="draggable" value="${item}">${item}</div></div>`;
    answers.append(el);
  });

  if (trys !== 0) renderBackBtn();
}

/* Genere les indicators des questions */
function renderIndicators() {
  arrLvl.map((_, i) => {
    const el = document.createElement("div");
    el.className = "indicator";
    el.setAttribute("value", i);
    question.append(el);
  });
}

window.onload = () => {
  renderIndicators();
  renderAnwers(active);
  title.innerText = arrLvl[active].question;
  current[active].classList.add("active");
};
